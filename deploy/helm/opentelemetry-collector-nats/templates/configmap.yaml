apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "opentelemetry-collector-nats.fullname" . }}
  labels:
    {{- include "opentelemetry-collector-nats.labels" . | nindent 4 }}
data:
  config.yaml: |
    {{- if eq .Values.mode "gateway" }}
    # Gateway mode: OTLP -> NATS
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: {{ .Values.batch.timeout }}
        send_batch_size: {{ .Values.batch.sendBatchSize }}
      memory_limiter:
        check_interval: {{ .Values.memoryLimiter.checkInterval }}
        limit_mib: {{ .Values.memoryLimiter.limitMib }}
        spike_limit_mib: {{ .Values.memoryLimiter.spikeLimitMib }}

    exporters:
      nats:
        url: {{ .Values.nats.url }}
        {{- if .Values.nats.auth }}
        auth:
          {{- if .Values.nats.auth.userInfo }}
          user_info:
            username: {{ .Values.nats.auth.userInfo.username | quote }}
            password: {{ .Values.nats.auth.userInfo.password | quote }}
          {{- end }}
          {{- if .Values.nats.auth.token }}
          token: {{ .Values.nats.auth.token | quote }}
          {{- end }}
          {{- if .Values.nats.auth.nkeyFile }}
          nkey_file: {{ .Values.nats.auth.nkeyFile | quote }}
          {{- end }}
          {{- if .Values.nats.auth.credentialsFile }}
          credentials_file: {{ .Values.nats.auth.credentialsFile | quote }}
          {{- end }}
        {{- end }}
        traces:
          subject: {{ .Values.gateway.traces.subject }}
        metrics:
          subject: {{ .Values.gateway.metrics.subject }}
        logs:
          subject: {{ .Values.gateway.logs.subject }}
        timeout: {{ .Values.gateway.timeout }}
        {{- if .Values.gateway.retryOnFailure.enabled }}
        retry_on_failure:
          enabled: true
          initial_interval: {{ .Values.gateway.retryOnFailure.initialInterval }}
          max_interval: {{ .Values.gateway.retryOnFailure.maxInterval }}
          max_elapsed_time: {{ .Values.gateway.retryOnFailure.maxElapsedTime }}
        {{- end }}
      debug:
        verbosity: basic

    service:
      extensions: [health_check]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [nats]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [nats]
        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [nats]
      telemetry:
        logs:
          level: {{ .Values.telemetry.logs.level }}
        metrics:
          level: {{ .Values.telemetry.metrics.level }}

    {{- else if eq .Values.mode "ingest" }}
    # Ingest mode: NATS -> backend
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    receivers:
      nats:
        url: {{ .Values.nats.url }}
        {{- if .Values.nats.auth }}
        auth:
          {{- if .Values.nats.auth.userInfo }}
          user_info:
            username: {{ .Values.nats.auth.userInfo.username | quote }}
            password: {{ .Values.nats.auth.userInfo.password | quote }}
          {{- end }}
          {{- if .Values.nats.auth.token }}
          token: {{ .Values.nats.auth.token | quote }}
          {{- end }}
          {{- if .Values.nats.auth.nkeyFile }}
          nkey_file: {{ .Values.nats.auth.nkeyFile | quote }}
          {{- end }}
          {{- if .Values.nats.auth.credentialsFile }}
          credentials_file: {{ .Values.nats.auth.credentialsFile | quote }}
          {{- end }}
        {{- end }}
        traces:
          subject: {{ .Values.ingest.traces.subject | quote }}
          queue_group: {{ .Values.ingest.traces.queueGroup }}
        metrics:
          subject: {{ .Values.ingest.metrics.subject | quote }}
          queue_group: {{ .Values.ingest.metrics.queueGroup }}
        logs:
          subject: {{ .Values.ingest.logs.subject | quote }}
          queue_group: {{ .Values.ingest.logs.queueGroup }}

    processors:
      batch:
        timeout: {{ .Values.batch.timeout }}
        send_batch_size: {{ .Values.batch.sendBatchSize }}

    exporters:
      {{- if .Values.ingest.backend.otlp.endpoint }}
      otlp:
        endpoint: {{ .Values.ingest.backend.otlp.endpoint }}
        tls:
          insecure: {{ .Values.ingest.backend.otlp.insecure }}
      {{- end }}
      {{- if .Values.ingest.backend.otlphttp.endpoint }}
      otlphttp:
        endpoint: {{ .Values.ingest.backend.otlphttp.endpoint }}
        tls:
          insecure: {{ .Values.ingest.backend.otlphttp.insecure }}
      {{- end }}
      debug:
        verbosity: basic

    service:
      extensions: [health_check]
      pipelines:
        {{- if .Values.ingest.backend.otlp.endpoint }}
        traces:
          receivers: [nats]
          processors: [batch]
          exporters: [otlp]
        logs:
          receivers: [nats]
          processors: [batch]
          exporters: [otlp]
        {{- end }}
        {{- if .Values.ingest.backend.otlphttp.endpoint }}
        metrics:
          receivers: [nats]
          processors: [batch]
          exporters: [otlphttp]
        {{- end }}
      telemetry:
        logs:
          level: {{ .Values.telemetry.logs.level }}
        metrics:
          level: {{ .Values.telemetry.metrics.level }}
    {{- end }}
