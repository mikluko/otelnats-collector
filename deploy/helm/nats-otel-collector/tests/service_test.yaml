suite: service tests
templates:
  - templates/service.yaml
tests:
  - it: should render Service in gateway mode
    set:
      mode: gateway
    asserts:
      - isKind:
          of: Service
      - equal:
          path: apiVersion
          value: v1

  - it: should use ClusterIP type by default
    set:
      mode: gateway
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should have correct OTLP gRPC port
    set:
      mode: gateway
      service:
        otlpGrpcPort: 4317
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 4317
            targetPort: otlp-grpc
            protocol: TCP
            name: otlp-grpc

  - it: should have correct OTLP HTTP port
    set:
      mode: gateway
      service:
        otlpHttpPort: 4318
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 4318
            targetPort: otlp-http
            protocol: TCP
            name: otlp-http

  - it: should allow custom port numbers
    set:
      mode: gateway
      service:
        otlpGrpcPort: 14317
        otlpHttpPort: 14318
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 14317
            name: otlp-grpc
            protocol: TCP
            targetPort: otlp-grpc
      - contains:
          path: spec.ports
          content:
            port: 14318
            name: otlp-http
            protocol: TCP
            targetPort: otlp-http

  - it: should not render Service in ingest mode
    set:
      mode: ingest
    asserts:
      - hasDocuments:
          count: 0

  - it: should include correct selector labels
    set:
      mode: gateway
    release:
      name: test-release
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: otelnats-collector
      - equal:
          path: spec.selector["app.kubernetes.io/instance"]
          value: test-release
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: gateway

  - it: should use fullname for metadata.name
    set:
      mode: gateway
    release:
      name: test-release
    asserts:
      - equal:
          path: metadata.name
          value: test-release-otelnats-collector
