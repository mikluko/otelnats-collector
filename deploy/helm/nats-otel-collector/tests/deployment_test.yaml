suite: deployment tests
templates:
  - templates/deployment.yaml
  - templates/configmap.yaml
tests:
  - it: should render Deployment with correct apiVersion and kind
    template: templates/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: apiVersion
          value: apps/v1

  - it: should use fullname for metadata.name
    template: templates/deployment.yaml
    release:
      name: test-release
    asserts:
      - equal:
          path: metadata.name
          value: test-release-otelnats-collector

  - it: should include OTLP ports in gateway mode
    template: templates/deployment.yaml
    set:
      mode: gateway
    asserts:
      - exists:
          path: spec.template.spec.containers[0].ports
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: otlp-grpc
            containerPort: 4317
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: otlp-http
            containerPort: 4318
            protocol: TCP

  - it: should not include ports in ingest mode
    template: templates/deployment.yaml
    set:
      mode: ingest
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].ports

  - it: should set replicas when autoscaling is disabled
    template: templates/deployment.yaml
    set:
      autoscaling:
        enabled: false
      replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should omit replicas when autoscaling is enabled
    template: templates/deployment.yaml
    set:
      autoscaling:
        enabled: true
    asserts:
      - notExists:
          path: spec.replicas

  - it: should include checksum annotation for config changes
    template: templates/deployment.yaml
    asserts:
      - exists:
          path: spec.template.metadata.annotations["checksum/config"]

  - it: should enforce security context defaults
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000

  - it: should drop all capabilities by default
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[0]
          value: ALL

  - it: should use default image tag from Chart.appVersion
    template: templates/deployment.yaml
    chart:
      appVersion: 1.2.3
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ":1.2.3$"

  - it: should use custom image tag when specified
    template: templates/deployment.yaml
    set:
      image:
        tag: custom-tag
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ":custom-tag$"

  - it: should render imagePullSecrets when set
    template: templates/deployment.yaml
    set:
      imagePullSecrets:
        - name: my-registry-secret
    asserts:
      - contains:
          path: spec.template.spec.imagePullSecrets
          content:
            name: my-registry-secret

  - it: should render nodeSelector when set
    template: templates/deployment.yaml
    set:
      nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should render tolerations when set
    template: templates/deployment.yaml
    set:
      tolerations:
        - key: "node-role.kubernetes.io/master"
          operator: "Exists"
          effect: "NoSchedule"
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "node-role.kubernetes.io/master"
            operator: "Exists"
            effect: "NoSchedule"

  - it: should render affinity when set
    template: templates/deployment.yaml
    set:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: topology.kubernetes.io/zone
                    operator: In
                    values:
                      - us-east-1a
    asserts:
      - exists:
          path: spec.template.spec.affinity.nodeAffinity

  - it: should render topologySpreadConstraints when set
    template: templates/deployment.yaml
    set:
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
    asserts:
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: topology.kubernetes.io/zone
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].maxSkew
          value: 1

  - it: should render extra volumes when set
    template: templates/deployment.yaml
    set:
      extraVolumes:
        - name: nats-creds
          secret:
            secretName: nats-credentials
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: nats-creds
            secret:
              secretName: nats-credentials

  - it: should render extra volume mounts when set
    template: templates/deployment.yaml
    set:
      extraVolumeMounts:
        - name: nats-creds
          mountPath: /etc/nats
          readOnly: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: nats-creds
            mountPath: /etc/nats
            readOnly: true

  - it: should mount config volume as read-only
    template: templates/deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config
            mountPath: /etc/otelcol
            readOnly: true

  - it: should configure liveness probe on health check port
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 13133

  - it: should configure readiness probe on health check port
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 13133

  - it: should apply resource limits and requests
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 128Mi

  - it: should render pod annotations when set
    template: templates/deployment.yaml
    set:
      podAnnotations:
        prometheus.io/scrape: "true"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"

  - it: should render pod labels when set
    template: templates/deployment.yaml
    set:
      podLabels:
        custom-label: custom-value
    asserts:
      - equal:
          path: spec.template.metadata.labels.custom-label
          value: custom-value
