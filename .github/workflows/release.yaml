name: Release
on:
  pull_request:
    branches: [ main ]
  push:
    tags: [ 'v*' ]

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}/${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - run: go test ./...

  release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - uses: azure/setup-helm@v4

      - uses: ko-build/setup-ko@v0.9

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Set version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA="${GITHUB_SHA::7}"
            echo "version=0.0.0-pr${{ github.event.pull_request.number }}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push image
        run: ko build --bare --platform=linux/amd64,linux/arm64 --tags ${{ steps.version.outputs.version }} .
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository }}

      - name: Build and push Helm chart
        run: |
          helm package deploy/helm/opentelemetry-collector-nats \
            --version ${{ steps.version.outputs.version }} \
            --app-version ${{ steps.version.outputs.version }}
          helm push opentelemetry-collector-nats-${{ steps.version.outputs.version }}.tgz \
            oci://ghcr.io/${{ github.repository_owner }}/helm-charts
