name: Release
on:
  pull_request:
    branches: [ main ]
  push:
    tags: [ 'v*' ]

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}/${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Verify build
        run: make build
      - name: Run tests
        run: make test

  release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - uses: azure/setup-helm@v4

      - uses: ko-build/setup-ko@v0.9

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Set version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-pr${{ github.event.pull_request.number }}-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "## Release: \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY

      - name: Build and push image
        run: |
          ko build --bare \
            --platform=linux/amd64,linux/arm64 \
            --tags ${{ steps.version.outputs.version }} \
            .
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository }}
          GOFLAGS: -ldflags=-X=main.version=${{ steps.version.outputs.version }}

      - name: Build and push Helm chart
        run: |
          helm package deploy/helm/opentelemetry-collector-nats \
            --version ${{ steps.version.outputs.version }} \
            --app-version ${{ steps.version.outputs.version }}
          helm push opentelemetry-collector-nats-${{ steps.version.outputs.version }}.tgz \
            oci://ghcr.io/${{ github.repository_owner }}/helm-charts

      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### Artifacts
          - **Image:** \`ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}\`
          - **Chart:** \`oci://ghcr.io/${{ github.repository_owner }}/helm-charts/opentelemetry-collector-nats:${{ steps.version.outputs.version }}\`
          EOF
