# Ingest mode with JetStream: NATS JetStream â†’ OTLP backend
# Consume telemetry from NATS JetStream with at-least-once delivery guarantees.
#
# Rate limiting (rate_limit/rate_burst) prevents CPU/memory spikes when
# catching up on backlogs after restarts.
#
# Usage:
#   helm install otelnats-ingest open-telemetry/opentelemetry-collector -f ingest-jetstream-values.yaml

image:
  repository: ghcr.io/mikluko/otelnats-collector
  tag: latest

mode: deployment

config:
  receivers:
    nats:
      url: nats://nats.nats-system:4222
      auth:
        credentials_file: /etc/nats/creds/ingest.creds
      traces:
        subject: "otel.traces.>"
        jetstream:
          stream: OTEL_TELEMETRY
          consumer: signal-traces
          ack_wait: 30s
          rate_limit: 1000
          rate_burst: 100
      metrics:
        subject: "otel.metrics.>"
        jetstream:
          stream: OTEL_TELEMETRY
          consumer: signal-metrics
          ack_wait: 30s
          rate_limit: 1000
          rate_burst: 100
      logs:
        subject: "otel.logs.>"
        jetstream:
          stream: OTEL_TELEMETRY
          consumer: signal-logs
          ack_wait: 30s
          rate_limit: 1000
          rate_burst: 100

  processors:
    batch:
      timeout: 1s
      send_batch_size: 1000

  exporters:
    otlp:
      endpoint: tempo.observability:4317
      tls:
        insecure: true
    otlphttp:
      endpoint: http://prometheus.observability:9090/api/v1/otlp
      tls:
        insecure: true

  extensions:
    health_check:
      endpoint: 0.0.0.0:13133

  service:
    extensions: [health_check]
    pipelines:
      traces:
        receivers: [nats]
        processors: [batch]
        exporters: [otlp]
      metrics:
        receivers: [nats]
        processors: [batch]
        exporters: [otlphttp]
      logs:
        receivers: [nats]
        processors: [batch]
        exporters: [otlp]

# Mount NATS credentials from secret
extraVolumes:
  - name: nats-creds
    secret:
      secretName: nats-ingest-creds

extraVolumeMounts:
  - name: nats-creds
    mountPath: /etc/nats/creds
    readOnly: true
